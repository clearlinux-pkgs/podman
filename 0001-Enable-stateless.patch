From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Ganesh Maharaj Mahalingam <ganesh.mahalingam@intel.com>
Date: Thu, 24 Mar 2022 21:44:59 -0700
Subject: [PATCH] Enable stateless

Signed-off-by: Ganesh Maharaj Mahalingam <ganesh.mahalingam@intel.com>
---
 Makefile                                      |  8 ++++++-
 additionalfiles/policy.json                   | 14 +++++++++++
 libpod/container_internal_linux.go            | 24 +++++++++++--------
 pkg/trust/trust.go                            |  2 +-
 .../containers/common/pkg/config/config.go    |  2 +-
 .../containers/common/pkg/config/default.go   |  2 +-
 .../image/v5/signature/policy_config.go       |  2 +-
 7 files changed, 39 insertions(+), 15 deletions(-)
 create mode 100644 additionalfiles/policy.json

diff --git a/Makefile b/Makefile
index 99a4e6f..4617827 100644
--- a/Makefile
+++ b/Makefile
@@ -42,6 +42,7 @@ LIBEXECDIR ?= ${PREFIX}/libexec
 LIBEXECPODMAN ?= ${LIBEXECDIR}/podman
 MANDIR ?= ${PREFIX}/share/man
 SHAREDIR_CONTAINERS ?= ${PREFIX}/share/containers
+DEFSHAREDIR_CONTAINERS ?= ${PREFIX}/share/defaults/containers
 ETCDIR ?= ${PREFIX}/etc
 TMPFILESDIR ?= ${PREFIX}/lib/tmpfiles.d
 MODULESLOADDIR ?= ${PREFIX}/lib/modules-load.d
@@ -757,7 +758,7 @@ package-install: package  ## Install rpm packages
 	/usr/bin/podman info  # will catch a broken conmon
 
 .PHONY: install
-install: .gopathok install.bin install.remote install.man install.systemd  ## Install binaries to system locations
+install: .gopathok install.bin install.remote install.man install.systemd install.additionalfiles ## Install binaries to system locations
 
 .PHONY: install.catatonit
 install.catatonit:
@@ -903,6 +904,11 @@ install.libseccomp.sudo:
 	git clone https://github.com/seccomp/libseccomp ../../seccomp/libseccomp
 	cd ../../seccomp/libseccomp && git checkout --detach $(LIBSECCOMP_COMMIT) && ./autogen.sh && ./configure --prefix=/usr && make all && make install
 
+.PHONY: install.additionalfiles
+install.additionalfiles:
+	install ${SELINUXOPT} -d -m 755 ${DESTDIR}${DEFSHAREDIR_CONTAINERS}
+	install ${SELINUXOPT} -m 644 additionalfiles/policy.json ${DESTDIR}${DEFSHAREDIR_CONTAINERS}/policy.json
+
 .PHONY: uninstall
 uninstall:
 	for i in $(filter %.1,$(MANPAGES_DEST)); do \
diff --git a/additionalfiles/policy.json b/additionalfiles/policy.json
new file mode 100644
index 0000000..dffc54a
--- /dev/null
+++ b/additionalfiles/policy.json
@@ -0,0 +1,14 @@
+{
+    "default": [
+        {
+            "type": "insecureAcceptAnything"
+        }
+    ],
+    "transports":
+        {
+            "docker-daemon":
+                {
+                    "": [{"type":"insecureAcceptAnything"}]
+                }
+        }
+}
diff --git a/libpod/container_internal_linux.go b/libpod/container_internal_linux.go
index f7c8c19..6864f3d 100644
--- a/libpod/container_internal_linux.go
+++ b/libpod/container_internal_linux.go
@@ -58,6 +58,10 @@ import (
 	"golang.org/x/sys/unix"
 )
 
+const (
+	hostsFilePath = "/usr/share/defaults/etc/hosts"
+)
+
 func (c *Container) mountSHM(shmOptions string) error {
 	if err := unix.Mount("shm", c.config.ShmDir, "tmpfs", unix.MS_NOEXEC|unix.MS_NOSUID|unix.MS_NODEV,
 		label.FormatMountLabel(shmOptions, c.config.MountLabel)); err != nil {
@@ -1836,11 +1840,11 @@ func (c *Container) makeBindMounts() error {
 				}
 				delete(c.state.BindMounts, "/etc/resolv.conf")
 			}
-			if hostsPath, ok := c.state.BindMounts["/etc/hosts"]; ok {
+			if hostsPath, ok := c.state.BindMounts[hostsFilePath]; ok {
 				if err := os.Remove(hostsPath); err != nil && !os.IsNotExist(err) {
 					return errors.Wrapf(err, "container %s", c.ID())
 				}
-				delete(c.state.BindMounts, "/etc/hosts")
+				delete(c.state.BindMounts, hostsFilePath)
 			}
 		}
 
@@ -1869,7 +1873,7 @@ func (c *Container) makeBindMounts() error {
 
 			// check if dependency container has an /etc/hosts file.
 			// It may not have one, so only use it if it does.
-			hostsPath, exists := bindMounts["/etc/hosts"]
+			hostsPath, exists := bindMounts[hostsFilePath]
 			if !c.config.UseImageHosts && exists {
 				depCtr.lock.Lock()
 				// generate a hosts file for the dependency container,
@@ -1884,7 +1888,7 @@ func (c *Container) makeBindMounts() error {
 				depCtr.lock.Unlock()
 
 				// finally, save it in the new container
-				c.state.BindMounts["/etc/hosts"] = hostsPath
+				c.state.BindMounts[hostsFilePath] = hostsPath
 			}
 
 			if !hasCurrentUserMapped(c) {
@@ -1905,14 +1909,14 @@ func (c *Container) makeBindMounts() error {
 			}
 
 			if !c.config.UseImageHosts {
-				if err := c.updateHosts("/etc/hosts"); err != nil {
+				if err := c.updateHosts(hostsFilePath); err != nil {
 					return errors.Wrapf(err, "error creating hosts file for container %s", c.ID())
 				}
 			}
 		}
 
-		if c.state.BindMounts["/etc/hosts"] != "" {
-			if err := c.relabel(c.state.BindMounts["/etc/hosts"], c.config.MountLabel, true); err != nil {
+		if c.state.BindMounts[hostsFilePath] != "" {
+			if err := c.relabel(c.state.BindMounts[hostsFilePath], c.config.MountLabel, true); err != nil {
 				return err
 			}
 		}
@@ -1923,8 +1927,8 @@ func (c *Container) makeBindMounts() error {
 			}
 		}
 	} else {
-		if !c.config.UseImageHosts && c.state.BindMounts["/etc/hosts"] == "" {
-			if err := c.updateHosts("/etc/hosts"); err != nil {
+		if !c.config.UseImageHosts && c.state.BindMounts[hostsFilePath] == "" {
+			if err := c.updateHosts(hostsFilePath); err != nil {
 				return errors.Wrapf(err, "error creating hosts file for container %s", c.ID())
 			}
 		}
@@ -2329,7 +2333,7 @@ func (c *Container) updateHosts(path string) error {
 	if err != nil {
 		return err
 	}
-	c.state.BindMounts["/etc/hosts"] = newHosts
+	c.state.BindMounts[hostsFilePath] = newHosts
 	return nil
 }
 
diff --git a/pkg/trust/trust.go b/pkg/trust/trust.go
index 584d1fa..0138c4d 100644
--- a/pkg/trust/trust.go
+++ b/pkg/trust/trust.go
@@ -69,7 +69,7 @@ var userRegistriesDir = filepath.FromSlash(".config/containers/registries.d")
 
 // DefaultPolicyPath returns a path to the default policy of the system.
 func DefaultPolicyPath(sys *types.SystemContext) string {
-	systemDefaultPolicyPath := "/etc/containers/policy.json"
+	systemDefaultPolicyPath := "/usr/share/defaults/containers/policy.json"
 	if sys != nil {
 		if sys.SignaturePolicyPath != "" {
 			return sys.SignaturePolicyPath
diff --git a/vendor/github.com/containers/common/pkg/config/config.go b/vendor/github.com/containers/common/pkg/config/config.go
index dd30abc..1e0acfb 100644
--- a/vendor/github.com/containers/common/pkg/config/config.go
+++ b/vendor/github.com/containers/common/pkg/config/config.go
@@ -23,7 +23,7 @@ const (
 	// inside a given config directory.
 	_configPath = "containers/containers.conf"
 	// DefaultContainersConfig holds the default containers config path
-	DefaultContainersConfig = "/usr/share/" + _configPath
+	DefaultContainersConfig = "/usr/share/defaults/" + _configPath
 	// OverrideContainersConfig holds the default config path overridden by the root user
 	OverrideContainersConfig = "/etc/" + _configPath
 	// UserOverrideContainersConfig holds the containers config path overridden by the rootless user
diff --git a/vendor/github.com/containers/common/pkg/config/default.go b/vendor/github.com/containers/common/pkg/config/default.go
index 2791197..f80b0d9 100644
--- a/vendor/github.com/containers/common/pkg/config/default.go
+++ b/vendor/github.com/containers/common/pkg/config/default.go
@@ -110,7 +110,7 @@ const (
 	DefaultPullPolicy = "missing"
 	// DefaultSignaturePolicyPath is the default value for the
 	// policy.json file.
-	DefaultSignaturePolicyPath = "/etc/containers/policy.json"
+	DefaultSignaturePolicyPath = "/usr/share/defaults/containers/policy.json"
 	// DefaultSubnet is the subnet that will be used for the default CNI
 	// network.
 	DefaultSubnet = "10.88.0.0/16"
diff --git a/vendor/github.com/containers/image/v5/signature/policy_config.go b/vendor/github.com/containers/image/v5/signature/policy_config.go
index 82fbb68..8b30723 100644
--- a/vendor/github.com/containers/image/v5/signature/policy_config.go
+++ b/vendor/github.com/containers/image/v5/signature/policy_config.go
@@ -35,7 +35,7 @@ var systemDefaultPolicyPath = builtinDefaultPolicyPath
 
 // builtinDefaultPolicyPath is the policy path used for DefaultPolicy().
 // DO NOT change this, instead see systemDefaultPolicyPath above.
-const builtinDefaultPolicyPath = "/etc/containers/policy.json"
+const builtinDefaultPolicyPath = "/usr/share/defaults/containers/policy.json"
 
 // userPolicyFile is the path to the per user policy path.
 var userPolicyFile = filepath.FromSlash(".config/containers/policy.json")
