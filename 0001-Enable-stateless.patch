From d6313a9b70a5ed176ec456c110a454e009b065f1 Mon Sep 17 00:00:00 2001
From: Ganesh Maharaj Mahalingam <ganesh.mahalingam@intel.com>
Date: Wed, 26 Jan 2022 10:28:47 -0800
Subject: [PATCH] Enable stateless

Signed-off-by: Ganesh Maharaj Mahalingam <ganesh.mahalingam@intel.com>
---
 Makefile                                           |  8 +++++++-
 additionalfiles/policy.json                        | 14 ++++++++++++++
 pkg/trust/trust.go                                 |  2 +-
 .../containers/common/pkg/config/config.go         |  2 +-
 .../containers/common/pkg/config/default.go        |  2 +-
 5 files changed, 24 insertions(+), 4 deletions(-)
 create mode 100644 additionalfiles/policy.json

diff --git a/Makefile b/Makefile
index 015690220..c13388995 100644
--- a/Makefile
+++ b/Makefile
@@ -39,6 +39,7 @@ BINDIR ?= ${PREFIX}/bin
 LIBEXECDIR ?= ${PREFIX}/libexec
 MANDIR ?= ${PREFIX}/share/man
 SHAREDIR_CONTAINERS ?= ${PREFIX}/share/containers
+DEFSHAREDIR_CONTAINERS ?= ${PREFIX}/share/defaults/containers
 ETCDIR ?= ${PREFIX}/etc
 TMPFILESDIR ?= ${PREFIX}/lib/tmpfiles.d
 SYSTEMDDIR ?= ${PREFIX}/lib/systemd/system
@@ -668,7 +669,7 @@ package-install: package  ## Install rpm packages
 	/usr/bin/podman info  # will catch a broken conmon
 
 .PHONY: install
-install: .gopathok install.bin install.remote install.man install.systemd  ## Install binaries to system locations
+install: .gopathok install.bin install.remote install.man install.systemd install.additionalfiles ## Install binaries to system locations
 
 .PHONY: install.catatonit
 install.catatonit:
@@ -807,6 +808,11 @@ install.libseccomp.sudo:
 	git clone https://github.com/seccomp/libseccomp ../../seccomp/libseccomp
 	cd ../../seccomp/libseccomp && git checkout --detach $(LIBSECCOMP_COMMIT) && ./autogen.sh && ./configure --prefix=/usr && make all && make install
 
+.PHONY: install.additionalfiles
+install.additionalfiles:
+	install ${SELINUXOPT} -d -m 755 ${DESTDIR}${DEFSHAREDIR_CONTAINERS}
+	install ${SELINUXOPT} -m 644 additionalfiles/policy.json ${DESTDIR}${DEFSHAREDIR_CONTAINERS}/policy.json
+
 .PHONY: uninstall
 uninstall:
 	for i in $(filter %.1,$(MANPAGES_DEST)); do \
diff --git a/additionalfiles/policy.json b/additionalfiles/policy.json
new file mode 100644
index 000000000..dffc54a62
--- /dev/null
+++ b/additionalfiles/policy.json
@@ -0,0 +1,14 @@
+{
+    "default": [
+        {
+            "type": "insecureAcceptAnything"
+        }
+    ],
+    "transports":
+        {
+            "docker-daemon":
+                {
+                    "": [{"type":"insecureAcceptAnything"}]
+                }
+        }
+}
diff --git a/pkg/trust/trust.go b/pkg/trust/trust.go
index 18a6a1717..57d50755c 100644
--- a/pkg/trust/trust.go
+++ b/pkg/trust/trust.go
@@ -69,7 +69,7 @@ var userRegistriesDir = filepath.FromSlash(".config/containers/registries.d")
 
 // DefaultPolicyPath returns a path to the default policy of the system.
 func DefaultPolicyPath(sys *types.SystemContext) string {
-	systemDefaultPolicyPath := "/etc/containers/policy.json"
+	systemDefaultPolicyPath := "/usr/share/defaults/containers/policy.json"
 	if sys != nil {
 		if sys.SignaturePolicyPath != "" {
 			return sys.SignaturePolicyPath
diff --git a/vendor/github.com/containers/common/pkg/config/config.go b/vendor/github.com/containers/common/pkg/config/config.go
index b78bcd74f..a8dbf54ee 100644
--- a/vendor/github.com/containers/common/pkg/config/config.go
+++ b/vendor/github.com/containers/common/pkg/config/config.go
@@ -23,7 +23,7 @@ const (
 	// inside a given config directory.
 	_configPath = "containers/containers.conf"
 	// DefaultContainersConfig holds the default containers config path
-	DefaultContainersConfig = "/usr/share/" + _configPath
+	DefaultContainersConfig = "/usr/share/defaults/" + _configPath
 	// OverrideContainersConfig holds the default config path overridden by the root user
 	OverrideContainersConfig = "/etc/" + _configPath
 	// UserOverrideContainersConfig holds the containers config path overridden by the rootless user
diff --git a/vendor/github.com/containers/common/pkg/config/default.go b/vendor/github.com/containers/common/pkg/config/default.go
index bc88e5135..442ca6ff6 100644
--- a/vendor/github.com/containers/common/pkg/config/default.go
+++ b/vendor/github.com/containers/common/pkg/config/default.go
@@ -113,7 +113,7 @@ const (
 	DefaultPullPolicy = "missing"
 	// DefaultSignaturePolicyPath is the default value for the
 	// policy.json file.
-	DefaultSignaturePolicyPath = "/etc/containers/policy.json"
+	DefaultSignaturePolicyPath = "/usr/share/defaults/containers/policy.json"
 	// DefaultSubnet is the subnet that will be used for the default CNI
 	// network.
 	DefaultSubnet = "10.88.0.0/16"
-- 
2.35.0

